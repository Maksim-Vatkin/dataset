
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Inter-batch parallelism &#8212; Dataset 0.2.1 documentation</title>
    <link rel="stylesheet" href="../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.2.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Working with models" href="models.html" />
    <link rel="prev" title="Within batch parallelism" href="parallel.html" /> 
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="models.html" title="Working with models"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="parallel.html" title="Within batch parallelism"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Dataset 0.2.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="classes.html" accesskey="U">Classes and capabilities</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="inter-batch-parallelism">
<h1>Inter-batch parallelism<a class="headerlink" href="#inter-batch-parallelism" title="Permalink to this headline">¶</a></h1>
<p>For long-running <a class="reference internal" href="pipeline.html"><span class="doc">pipelines</span></a> you might employ a <cite>prefetch</cite> feature which allows for a parallel batch processing.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">some_pipeline</span><span class="o">.</span><span class="n">gen_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This line states that 3 additional batches should be processed in the background.
Take into account that all the batches will be processed simultaneously without any prioritization.
However, the order of batches is preserved, i.e. batch #2 would be returned after batch #1 even if all the actions for batch #2 finished earlier. This statement is correct even for shuffled order (though it might seem illogical to some people).</p>
<p>Let’s look at an example. Here is a simple pipeline:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">some_pipeline</span> <span class="o">=</span> <span class="n">some_dataset</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">action1</span><span class="p">()</span><span class="o">.</span><span class="n">action2</span><span class="p">()</span><span class="o">.</span><span class="n">action3</span><span class="p">()</span>
</pre></div>
</div>
<p>At first, we run it without <cite>prefetch</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">some_pipeline</span><span class="o">.</span><span class="n">gen_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The execution sequence will look as follows:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="c1">#1 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span>
<span class="n">batch</span> <span class="c1">#2 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span>
<span class="n">batch</span> <span class="c1">#3 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span>
</pre></div>
</div>
<p>So, all the batches start one after another, and all the actions also start one after another.</p>
<p>Now use <cite>prefetch</cite>:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">some_pipeline</span><span class="o">.</span><span class="n">gen_batch</span><span class="p">(</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">prefetch</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>This changes the execution sequence dramatically:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">batch</span> <span class="c1">#1 is created</span>
<span class="n">batch</span> <span class="c1">#2 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#1</span>
<span class="n">batch</span> <span class="c1">#3 is created</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#2 &lt;-- after that batch #4 could start</span>
    <span class="n">action</span> <span class="mi">1</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">2</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">started</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
    <span class="n">action</span> <span class="mi">3</span> <span class="n">finished</span> <span class="k">for</span> <span class="n">batch</span> <span class="c1">#3</span>
</pre></div>
</div>
<p>Batch #2 is created immediately after batch #1. Then all the actions are executed for all running batches.
As actions execution time might vary between batches, the actual sequence might look different in your case.</p>
<p>However, the main principle remains the same - <cite>prefetch</cite> parameter indicates how many additional batches should be processed in advance, before you need them. As a consequence, when you need them, they will be returned much faster or even almost immediately (if all the actions have been executed already).</p>
<p>You can use <cite>prefetch</cite> in <cite>next_batch</cite>, <cite>gen_batch</cite> and <cite>run</cite>.</p>
<div class="section" id="blocked-method">
<h2>Blocked method<a class="headerlink" href="#blocked-method" title="Permalink to this headline">¶</a></h2>
<p>Sometimes you might want to guarantee that only one call of a specific action is executed simultaneously, e.g. due to a race condition or dependence on some external resources. To make this happen provide a lock to an action:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyBatch</span><span class="p">(</span><span class="n">Batch</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="nd">@action</span><span class="p">(</span><span class="n">use_lock</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">only_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
    <span class="o">...</span>

    <span class="nd">@action</span><span class="p">(</span><span class="n">use_lock</span><span class="o">=</span><span class="s2">&quot;unique_lock_name&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">also_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Thus, whenever you make prefetching, only one batch at a time will execute <cite>only_one</cite> action.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Inter-batch parallelism</a><ul>
<li><a class="reference internal" href="#blocked-method">Blocked method</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="parallel.html"
                        title="previous chapter">Within batch parallelism</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="models.html"
                        title="next chapter">Working with models</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/intro/prefetch.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="models.html" title="Working with models"
             >next</a> |</li>
        <li class="right" >
          <a href="parallel.html" title="Within batch parallelism"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Dataset 0.2.1 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="classes.html" >Classes and capabilities</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Analysis Center.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>